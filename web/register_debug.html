<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨å†ŒåŠŸèƒ½è°ƒè¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">ğŸ” æ³¨å†ŒåŠŸèƒ½è°ƒè¯•</h1>
        
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle me-2"></i>è°ƒè¯•è¯´æ˜</h5>
            <p>è¿™ä¸ªé¡µé¢ç”¨äºè¯Šæ–­ç”¨æˆ·æ³¨å†Œå¤±è´¥çš„å…·ä½“åŸå› ã€‚</p>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">æœåŠ¡å™¨è¿æ¥æµ‹è¯•</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-3" onclick="testServerConnection()">
                            <i class="fas fa-plug me-1"></i>æµ‹è¯•æœåŠ¡å™¨è¿æ¥
                        </button>
                        <div id="serverTest"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">æ³¨å†ŒåŠŸèƒ½æµ‹è¯•</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">ç”¨æˆ·å</label>
                            <input type="text" id="debugUsername" class="form-control" value="æµ‹è¯•ç”¨æˆ·">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">é‚®ç®±</label>
                            <input type="email" id="debugEmail" class="form-control" value="test@example.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ‰‹æœºå·</label>
                            <input type="tel" id="debugPhone" class="form-control" value="13800138000">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å¯†ç </label>
                            <input type="password" id="debugPassword" class="form-control" value="123456">
                        </div>
                        <button class="btn btn-success" onclick="testRegister()">
                            <i class="fas fa-user-plus me-1"></i>æµ‹è¯•æ³¨å†Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">è°ƒè¯•æ—¥å¿—</h5>
                    </div>
                    <div class="card-body">
                        <div id="debugLog" style="max-height: 400px; overflow-y: auto;">
                            <p class="text-muted">ç­‰å¾…æµ‹è¯•ç»“æœ...</p>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary mt-2" onclick="clearLog()">
                            <i class="fas fa-trash me-1"></i>æ¸…é™¤æ—¥å¿—
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">å¯èƒ½çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ</h5>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="troubleshootAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#problem1">
                                        é—®é¢˜1ï¼šæœåŠ¡å™¨è¿æ¥å¤±è´¥
                                    </button>
                                </h2>
                                <div id="problem1" class="accordion-collapse collapse show">
                                    <div class="accordion-body">
                                        <strong>å¯èƒ½åŸå› ï¼š</strong>
                                        <ul>
                                            <li>save_user.phpæ–‡ä»¶ä¸å­˜åœ¨æˆ–è·¯å¾„é”™è¯¯</li>
                                            <li>æœåŠ¡å™¨ä¸æ”¯æŒPHP</li>
                                            <li>æ–‡ä»¶æƒé™é—®é¢˜</li>
                                        </ul>
                                        <strong>è§£å†³æ–¹æ¡ˆï¼š</strong>
                                        <ul>
                                            <li>ç¡®è®¤save_user.phpæ–‡ä»¶åœ¨ç½‘ç«™æ ¹ç›®å½•</li>
                                            <li>æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ”¯æŒPHP</li>
                                            <li>è®¾ç½®æ–‡ä»¶æƒé™ä¸º755</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#problem2">
                                        é—®é¢˜2ï¼šæ•°æ®ä¿å­˜å¤±è´¥
                                    </button>
                                </h2>
                                <div id="problem2" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <strong>å¯èƒ½åŸå› ï¼š</strong>
                                        <ul>
                                            <li>users_data.jsonæ–‡ä»¶æ— æ³•åˆ›å»º</li>
                                            <li>ç›®å½•å†™å…¥æƒé™ä¸è¶³</li>
                                            <li>ç£ç›˜ç©ºé—´ä¸è¶³</li>
                                        </ul>
                                        <strong>è§£å†³æ–¹æ¡ˆï¼š</strong>
                                        <ul>
                                            <li>è®¾ç½®ç½‘ç«™ç›®å½•å†™å…¥æƒé™</li>
                                            <li>æ‰‹åŠ¨åˆ›å»ºusers_data.jsonæ–‡ä»¶</li>
                                            <li>æ£€æŸ¥ç£ç›˜ç©ºé—´</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#problem3">
                                        é—®é¢˜3ï¼šCORSè·¨åŸŸé—®é¢˜
                                    </button>
                                </h2>
                                <div id="problem3" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <strong>å¯èƒ½åŸå› ï¼š</strong>
                                        <ul>
                                            <li>æµè§ˆå™¨é˜»æ­¢è·¨åŸŸè¯·æ±‚</li>
                                            <li>æœåŠ¡å™¨CORSé…ç½®é—®é¢˜</li>
                                        </ul>
                                        <strong>è§£å†³æ–¹æ¡ˆï¼š</strong>
                                        <ul>
                                            <li>ç¡®è®¤save_user.phpä¸­æœ‰CORSå¤´è®¾ç½®</li>
                                            <li>ä½¿ç”¨ç›¸åŒåŸŸåè®¿é—®</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // æµ‹è¯•æœåŠ¡å™¨è¿æ¥
        async function testServerConnection() {
            log('å¼€å§‹æµ‹è¯•æœåŠ¡å™¨è¿æ¥...');
            
            try {
                // æµ‹è¯•GETè¯·æ±‚
                log('å‘é€GETè¯·æ±‚åˆ°save_user.php...');
                const response = await fetch('save_user.php');
                
                log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                log(`å“åº”å¤´: ${JSON.stringify(Object.fromEntries(response.headers))}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                log(`å“åº”å†…å®¹: ${text}`);
                
                try {
                    const data = JSON.parse(text);
                    log('JSONè§£ææˆåŠŸ');
                    log(`è§£æç»“æœ: ${JSON.stringify(data, null, 2)}`);
                    
                    if (data.success) {
                        log('âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸ï¼');
                        document.getElementById('serverTest').innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>æœåŠ¡å™¨è¿æ¥æ­£å¸¸<br>
                                <small>ç”¨æˆ·æ•°é‡: ${data.total_users}</small>
                            </div>
                        `;
                    } else {
                        log('âŒ æœåŠ¡å™¨è¿”å›é”™è¯¯: ' + data.message);
                    }
                } catch (parseError) {
                    log('âŒ JSONè§£æå¤±è´¥: ' + parseError.message);
                    log('å¯èƒ½æ˜¯PHPé”™è¯¯æˆ–HTMLè¾“å‡º');
                }
                
            } catch (error) {
                log('âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥: ' + error.message);
                document.getElementById('serverTest').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>æœåŠ¡å™¨è¿æ¥å¤±è´¥<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }
        
        // æµ‹è¯•æ³¨å†ŒåŠŸèƒ½
        async function testRegister() {
            const username = document.getElementById('debugUsername').value;
            const email = document.getElementById('debugEmail').value;
            const phone = document.getElementById('debugPhone').value;
            const password = document.getElementById('debugPassword').value;
            
            log('å¼€å§‹æµ‹è¯•æ³¨å†ŒåŠŸèƒ½...');
            log(`ç”¨æˆ·å: ${username}`);
            log(`é‚®ç®±: ${email}`);
            log(`æ‰‹æœº: ${phone}`);
            log(`å¯†ç : ${password}`);
            
            const userData = {
                id: Date.now(),
                username: username,
                email: email,
                phone: phone,
                password: password,
                avatar: null,
                register_time: new Date().toISOString(),
                last_login: null
            };
            
            const requestData = {
                action: 'register',
                userData: userData
            };
            
            log('å‡†å¤‡å‘é€çš„æ•°æ®:');
            log(JSON.stringify(requestData, null, 2));
            
            try {
                log('å‘é€POSTè¯·æ±‚åˆ°save_user.php...');
                const response = await fetch('save_user.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                log(`å“åº”å†…å®¹: ${text}`);
                
                try {
                    const result = JSON.parse(text);
                    log('JSONè§£ææˆåŠŸ');
                    log(`è§£æç»“æœ: ${JSON.stringify(result, null, 2)}`);
                    
                    if (result.success) {
                        log('âœ… æ³¨å†ŒæˆåŠŸï¼');
                        alert('æ³¨å†Œæµ‹è¯•æˆåŠŸï¼');
                    } else {
                        log('âŒ æ³¨å†Œå¤±è´¥: ' + result.message);
                        alert('æ³¨å†Œæµ‹è¯•å¤±è´¥: ' + result.message);
                    }
                } catch (parseError) {
                    log('âŒ JSONè§£æå¤±è´¥: ' + parseError.message);
                    log('æœåŠ¡å™¨å¯èƒ½è¿”å›äº†HTMLé”™è¯¯é¡µé¢');
                    alert('æ³¨å†Œå¤±è´¥: æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯');
                }
                
            } catch (error) {
                log('âŒ æ³¨å†Œè¯·æ±‚å¤±è´¥: ' + error.message);
                alert('æ³¨å†Œå¤±è´¥: ' + error.message);
            }
        }
        
        // è®°å½•æ—¥å¿—
        function log(message) {
            const logDiv = document.getElementById('debugLog');
            const time = new Date().toLocaleTimeString();
            
            logDiv.innerHTML += `
                <div class="border-bottom pb-1 mb-1">
                    <small class="text-muted">[${time}]</small> ${message}
                </div>
            `;
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
            console.log(`[${time}] ${message}`);
        }
        
        // æ¸…é™¤æ—¥å¿—
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '<p class="text-muted">æ—¥å¿—å·²æ¸…é™¤...</p>';
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•æœåŠ¡å™¨è¿æ¥
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(testServerConnection, 1000);
        });
    </script>
</body>
</html>
